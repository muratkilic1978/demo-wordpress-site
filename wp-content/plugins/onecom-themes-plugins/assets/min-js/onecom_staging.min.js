!function(a){var r={anyProcess:{type:"",active:!1,timer:""},jobFinished:!1,getLogs:!1};function e(){var e={action:"wpstg_scanning",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,n){console.log(e.status+" "+e.statusText+"---"+t),h()},success:function(e){var t;!0!==e.error?(a("#dir_list").html("").html(e),a("#dir_list").length&&a("#dir_list").find(".wpstg-expand-dirs").bind("click",function(e){e.preventDefault(),a(this).hasClass("disabled")||a(this).siblings(".wpstg-subdir").slideToggle()}),t={action:"wpstg_check_disk_space",nonce:wpstg.nonce},a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:t,error:function(e,t,n){console.log(e.status+" "+e.statusText+"---"+t),h()},success:function(e){!0!==e.error?!1!==e?(function(){m(wpstg.msgPrep,0,0);var e=wpstg.stgID,t=wpstg.stgPrefix,n=c(),o=l(),s=g(),r=d();data={action:"wpstg_cloning",nonce:wpstg.nonce,cloneID:e,stgPrefix:t,excludedTables:n,includedDirectories:o,excludedDirectories:s,extraDirectories:r},a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,n){console.log(e.status+" "+e.statusText),h()},success:function(e){void 0===e.error||void 0===e.message?(m(wpstg.msgPrep,100,0),u()):h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}(),a("#av_space").html("Available free disk space "+e.freespace+" <br> Estimated necessary disk space: "+e.usedspace).show()):a("#onme_errors").text("Can not detect disk space.").show():h(e.message)},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})):h(e.message)},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function s(){var e=a("#console_log");void 0!==e[0]&&e.scrollTop(e[0].scrollHeight)}function i(e){null!=e&&void 0!==e&&e.constructor===Array&&a.each(e,function(e,t){null!==t&&t.type}),s()}function c(){var e=[];return a(".onestaging-db-table input:not(:checked)").each(function(){e.push(this.name)}),e}function l(){var t=[];return a(".wpstg-dir input:checked").each(function(){var e=a(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function g(){var t=[];return a(".wpstg-dir input:not(:checked)").each(function(){var e=a(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function d(){var e=[];if(!a("#wpstg_extraDirectories").val())return e;e=a("#wpstg_extraDirectories").val().split(/\r?\n/);return console.log(e),e}function u(){m(wpstg.msgNewStg,0,0),setTimeout(function(){m(wpstg.msgCopyDB,0,0),function t(){!0===r.getLogs&&i();setTimeout(function(){var e={action:"wpstg_clone_database",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,n){console.log(e.status+" "+e.statusText),h()},success:function(e){void 0===e.error||void 0===e.message?(m(wpstg.msgCopyDB,e.percentage,0),void 0!==e.last_msg&&i(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){m(wpstg.msgPrepDirs,0,0),function t(){if(!0===r.jobFinished)return!1;!0===r.getLogs&&i();a("#clone_log").append("Creating Directory Tree...<hr>");setTimeout(function(){var e={action:"wpstg_clone_prepare_directories",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,n){h()},success:function(e){void 0===e.error||void 0===e.message?(m(wpstg.msgPrepDirs,e.percentage,0),void 0!==e.last_msg&&i(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&(m(wpstg.msgCopyFiles,0,0),function t(){if(!0===r.jobFinished)return!1;!0===r.getLogs&&i();var e={action:"wpstg_clone_files",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,n){h()},success:function(e){void 0===e.error||void 0===e.message?(void 0!==e.percentage&&m(wpstg.msgCopyFiles,e.percentage,0),void 0!==e.last_msg&&i(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){!function t(){if(!0===r.jobFinished)return!1;!0===r.getLogs&&i();var e={action:"wpstg_clone_replace_data",nonce:wpstg.nonce};m(wpstg.msgUpdateDB,0,0);a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,n){h()},success:function(e){void 0===e.error||void 0===e.message?(m(wpstg.msgUpdateDB,e.percentage,0),void 0!==e.last_msg&&i(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&function n(e){if(!0===r.jobFinished)return function(e){a("#clone_area_head").find(".spinner").removeClass("is-active"),"undefined"!=e&&"undefined"!=e.url&&a("#onme_errors").html("Staging site created : "+e.url+"/wp-admin/").addClass("green").slideDown();a(".stopwatch._clone").addClass("done")}(e),!1;m(wpstg.msgFinalize,0,0);var t=((new Date).getTime()-r.anyProcess.timer).toFixed(0);t=(t/1e3).toFixed(2);var o={action:"wpstg_clone_finish",nonce:wpstg.nonce,totalTime:t};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:o,error:function(e,t,n){h(),r.anyProcess.timer=""},success:function(e){if("object"!=typeof e)return console.log("Couldn't finish the cloning process properly. Your snapshot has been copied but failed to do clean up and saving its records to the database."),void(r.anyProcess.timer="");var t;r.anyProcess.type="",r.anyProcess.active=!1,r.anyProcess.timer="",window.onbeforeunload="",t={action:"wpstg_get_staging",nonce:wpstg.nonce},a.ajax({url:ajaxurl,type:"POST",data:t,error:function(e,t,n){console.log(e.status+" "+e.statusText+"---"+t),a("#onme_errors").html("").html("Failed to get staging details, please reload the page and try again.")},success:function(e){a(document).find("#staging_entry").slideUp().remove(),a("#staging-create").slideUp("fast").before(e),a(".one-staging-msg").removeClass("hide"),window.location.reload()},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}),a(".onecom-notifier").html(wpstg.copy_msg).attr("type","success").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},3e3),void 0!==e.last_msg&&i(e.last_msg),m(wpstg.msgFinished,100,1),s(),r.jobFinished=!0,n(e)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}()):h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}()},wpstg.cpuLoad)):h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}())):h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500)}()},wpstg.cpuLoad)):h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500)}()},wpstg.cpuLoad)}function t(){if(!0===r.anyProcess.active)switch(r.anyProcess.type){case"stg":return"Staging creation will get interrupted if you leave or reload this page.";case"live":return"Copy staging to live will get interrupted if you leave or reload this page.";case"delete":return"Staging will not get deleted properly if you leave or reload this page.";case"update":return"Staging updation will get interrupted if you leave or reload this page.";default:return"Please do not leave the page. The current process will get interrupted."}return!0}function h(e){var t=wpstg.error_msg;void 0!==e&&e.length&&(t=e),a(".onecom-notifier").html(t).attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3),function(e,t){if(!e.length)return;var n=t,o=e,s={action:"wpstg_clone_log_error",nonce:wpstg.nonce,stg_action:o,msg:n};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:s,error:function(e,t,n){console.log("Could not log the error"),r.anyProcess.type="",r.anyProcess.active=!1,window.onbeforeunload=""},success:function(e){r.anyProcess.type="",r.anyProcess.active=!1,window.onbeforeunload=""}})}(r.anyProcess.type,t)}function m(e,t,n){if(e.length){if(a(".loading-overlay.show").find(".onecom_progress_bar").length)a(".loading-overlay.show .onecom_progress_bar .job").html(e),0==t?a(".loading-overlay.show .onecom_progress_bar span").hide().width(t+"%").show():a(".loading-overlay.show .onecom_progress_bar span").width(t+"%");else{var o='<div class="onecom_progress_bar" style="display: none;"><div class="job">'+e+'</div><span style="width:'+t+'%"></span></div>';a(".loading-overlay.show").find(".loader").before(o),a(".loading-overlay.show").find(".onecom_progress_bar").slideDown("fast")}n.length&&1===n&&a(".loading-overlay.show").find(".onecom_progress_bar").slideUp("fast")}}window.onbeforeunload="",a(".one-button-create-staging").on("click",function(){a(".loading-overlay.new-staging").addClass("show"),r.anyProcess.type="staging_create",r.anyProcess.active=!0,r.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=t,e()}),a(".one-button-update-staging").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),n=a(this).attr("data-dialog-id"),o=a(this).attr("data-title");tb_show(o,"#TB_inline?width="+e+"&height="+t+"&inlineId="+n+"&modal=true&class=thickbox",null)}),a(".one-button-update-staging-confirm").click(function(){a(".loading-overlay.update-loader").addClass("show"),a(".one-dialog-close").trigger("click");var e=a(".one-staging-entry").data("staging-id");e?(r.anyProcess.type="staging_rebuild",r.anyProcess.active=!0,r.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=t,function(e){if(e){var t=e,n=c(),o=l(),s=g(),r=d();data={action:"wpstg_update",nonce:wpstg.nonce,cloneID:t,excludedTables:n,includedDirectories:o,excludedDirectories:s,extraDirectories:r},console.log("Preparing for UPDATING cloning..."),a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,n){h()},success:function(e){void 0===e.error||void 0===e.message?u():h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}}(e)):(a(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3))}),a(".one-button-update-staging-cancel").click(function(){a(this).parents().find(".one-dialog-close").trigger("click")}),a(".one-button-delete-staging").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),n=a(this).attr("data-dialog-id"),o=a(this).attr("data-title");tb_show(o,"#TB_inline?width="+e+"&height="+t+"&inlineId="+n+"&modal=true&class=thickbox",null)}),a(".one-button-delete-staging-confirm").click(function(){a(".loading-overlay.delete-loader").first().addClass("show");var e=a(".one-staging-entry").data("staging-id");e?(a(".one-dialog-close").trigger("click"),r.anyProcess.type="staging_delete",r.anyProcess.active=!0,r.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=t,function t(n){var e=((new Date).getTime()-r.anyProcess.timer).toFixed(2);e=(e/1e3).toFixed(2),data={action:"wpstg_delete_clone",clone:n,nonce:wpstg.nonce,excludedTables:c(),deleteDir:a("#deleteDirectory:checked").val(),totalTime:e},m(wpstg.msgDelStg,0,0),a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:data,error:function(e,t,n){a("#onme_errors").text("Some error occurred").show(),h(data.message)},success:function(e){if(e){if(void 0!==e.error&&void 0!==e.message)return void h(e.message);if(void 0!==e.delete&&"finished"===e.delete)return m(wpstg.msgDelStg,100,1),a("#entry_"+n).fadeIn(5e3,function(){a(this).remove()}),r.anyProcess.type="",r.anyProcess.active=!1,window.onbeforeunload="",window.location.reload(),a(".onecom-notifier").html("Staging website has been removed.").attr("type","success").addClass("show"),void setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click"),a(".one-staging-details").hide(),a(".one-staging-actions").hide(),a("#staging-create").slideDown(),a(".one-card-staging-create").fadeIn(300)},7e3)}!0===e||t(n)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}(e)):(a(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3))}),a(".one-button-copy-to-live").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),n=a(this).attr("data-dialog-id"),o=a(this).attr("data-title");tb_show(o,"#TB_inline?width="+e+"&height="+t+"&inlineId="+n+"&modal=true&class=thickbox",null)}),a(".one-button-copy-to-live-cancel, .one-button-delete-staging-cancel").click(function(){a(".one-dialog-close").trigger("click")}),a("#one-button-copy-to-live-confirm").on("click",function(){a(".loading-overlay.deploy-loader").addClass("show"),a(".one-dialog-close").trigger("click");var e=a("#deploy_to_live").data("live-id");console.log("Starting deployment Staging-to-Live : "+e),r.anyProcess.type="staging_deploy",r.anyProcess.active=!0,r.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=t,function(e){if(e){var t=e,n=c(),o=l(),s=g(),r=d();console.log(o),data={action:"wpstg_deploy",nonce:wpstg.nonce,liveDirectory:t,excludedTables:n,includedDirectories:o,excludedDirectories:s,extraDirectories:r},a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,n){console.log(e.status+" "+e.statusText),h()},success:function(e){void 0===e.error||void 0===e.message?u():h(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}}(e)})}(jQuery);